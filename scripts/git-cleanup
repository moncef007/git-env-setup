#!/bin/bash
# 
# git-cleanup - Clean up merged branches and optimize repository
# Usage: git cleanup [--dry-run]
#
# Copyright (C) 2025 Mohamed Elmoncef HAMDI <mohamedelmoncef.hamdi@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -e

DRY_RUN=false
if [ "$1" = "--dry-run" ]; then
    DRY_RUN=true
    echo -e "üîç DRY RUN MODE - No changes will be made"
fi

echo -e "üßπ Cleaning up repository..."

CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
echo "Current branch: $CURRENT_BRANCH"

PROTECTED_BRANCHES="main|master|develop|staging|production"

echo -e "\nFinding merged branches..."
MERGED_BRANCHES=$(git branch --merged | grep -vE "^\*|$PROTECTED_BRANCHES" | sed 's/^[ \t]*//' || true)

if [ -z "$MERGED_BRANCHES" ]; then
    echo -e "‚úì No merged branches to clean up"
else
    echo "Merged branches:"
    echo "$MERGED_BRANCHES"
    
    if [ "$DRY_RUN" = false ]; then
        echo ""
        read -p "Delete these branches? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "$MERGED_BRANCHES" | xargs -n 1 git branch -d
            echo -e "‚úì Deleted merged branches"
        fi
    fi
fi

echo -e "\nFinding stale remote branches..."
git fetch --prune

STALE_REMOTES=$(git branch -r --merged | grep -vE "origin/(main|master|develop|staging|production|HEAD)" | sed 's/origin\///' || true)

if [ -z "$STALE_REMOTES" ]; then
    echo -e "‚úì No stale remote branches"
else
    echo "Merged remote branches:"
    echo "$STALE_REMOTES"
    
    if [ "$DRY_RUN" = false ]; then
        echo ""
        echo -e "‚ö† This will delete branches from the remote!"
        read -p "Delete these remote branches? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "$STALE_REMOTES" | xargs -I {} git push origin --delete {}
            echo -e "‚úì Deleted stale remote branches"
        fi
    fi
fi

echo -e "\nPruning stale tracking branches..."
if [ "$DRY_RUN" = false ]; then
    git remote prune origin
    echo -e "‚úì Pruned stale tracking branches"
else
    git remote prune origin --dry-run
fi

echo -e "\nCleaning reflog..."
if [ "$DRY_RUN" = false ]; then
    git reflog expire --expire=30.days --all
    echo -e "‚úì Cleaned reflog (30+ days)"
fi

echo -e "\nRunning garbage collection..."
if [ "$DRY_RUN" = false ]; then
    git gc --prune=now --aggressive
    echo -e "‚úì Garbage collection complete"
fi

echo -e "\nüìä Repository Statistics:"
echo "Size: $(du -sh .git | cut -f1)"
echo "Objects: $(git count-objects -v | grep 'count:' | awk '{print $2}')"
echo "Branches: $(git branch -a | wc -l | tr -d ' ')"
echo "Commits: $(git rev-list --count HEAD)"

if [ "$DRY_RUN" = true ]; then
    echo -e "\nThis was a dry run. Run without --dry-run to apply changes"
else
    echo -e "\n‚úì Cleanup complete!"
fi